import{c as g}from"./chunk-5J2A4TKV.js";import{a as d}from"./chunk-M2GT5SNT.js";import{O as p,T as m}from"./chunk-SFQMZB6G.js";import{h as l}from"./chunk-FK42CRUA.js";var S=class u{constructor(e,t){this.supabaseService=e;this.router=t}login(e,t){return l(this,null,function*(){let{data:o,error:s}=yield this.supabaseService.client.auth.signInWithPassword({email:e,password:t});if(s)throw s;let r=o.user;if(!r)throw new Error("No se pudo obtener el usuario.");let a=null,i=null;try{let{data:c,error:n}=yield this.supabaseService.client.from("usuarios").select("id_rol").eq("id_usuario",r.id).maybeSingle();if(n)if(console.warn("Error al obtener perfil del usuario:",n),n.code==="PGRST116"||n.message?.includes("406"))console.warn("Error 406: Posible problema de permisos RLS. Intentando continuar...");else throw new Error(`Error al obtener perfil: ${n.message}`);else a=c,i=a?.id_rol??null}catch(c){console.error("Error al consultar perfil de usuario:",c),i=null}if(localStorage.setItem("session",JSON.stringify(o.session)),localStorage.setItem("token",o.session.access_token),localStorage.setItem("user_id",r.id),i!==null)localStorage.setItem("rol",i.toString());else throw localStorage.removeItem("rol"),new Error("Usuario sin rol asignado. Contacte al administrador.");return o.session})}register(e,t,o){return l(this,null,function*(){let{data:s,error:r}=yield this.supabaseService.client.auth.signUp({email:e,password:t});if(r)throw r;let a=s.user;if(!a)throw new Error("No se pudo crear el usuario en auth.");let{error:i}=yield this.supabaseService.client.from("usuarios").insert({id_usuario:a.id,nombre_usuario:o,id_rol:null,nombre:null,apellido:null});if(i)throw i;return s})}registerInternal(e,t){return l(this,null,function*(){let{data:o,error:s}=yield this.supabaseService.client.auth.signUp({email:e,password:t});if(s)throw s;let r=o.user;if(!r)throw new Error("No se pudo crear el usuario en auth.");return{user:r}})}logout(){return l(this,null,function*(){yield this.supabaseService.client.auth.signOut(),localStorage.removeItem("session"),localStorage.removeItem("token"),localStorage.removeItem("user_id"),this.router.navigate(["/"])})}getSession(){let e=localStorage.getItem("session");return e?JSON.parse(e):null}isAuthenticated(){return!!this.getSession()}static \u0275fac=function(t){return new(t||u)(m(d),m(g))};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};export{S as a};
