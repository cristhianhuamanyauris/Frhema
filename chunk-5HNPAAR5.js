import{a as h}from"./chunk-M2GT5SNT.js";import{O as f,T as m}from"./chunk-SFQMZB6G.js";import{h as s}from"./chunk-FK42CRUA.js";var k=class l{constructor(t){this.supabase=t}TABLE="productos";TABLE_MOVIMIENTOS="movimientos_stock";getProductos(t=!1){return s(this,null,function*(){try{let o=this.supabase.client.from(this.TABLE).select("*");t||(o=o.or("activo.is.null,activo.eq.true"));let{data:r,error:c}=yield o.order("id_producto",{ascending:!0});if(c){let d=c.message||"";if(d.includes("column")||d.includes("activo")||d.includes("does not exist")){console.warn("Campo activo no existe en Supabase. Cargando todos los productos sin filtro.");let{data:e,error:a}=yield this.supabase.client.from(this.TABLE).select("*").order("id_producto",{ascending:!0});if(a)throw a;return e.filter(n=>t?!0:n.activo===null||n.activo===void 0||n.activo===!0)}throw c}return r}catch(o){return console.error("Error al cargar productos:",o),[]}})}addProducto(t){return s(this,null,function*(){let{data:o,error:r}=yield this.supabase.client.from(this.TABLE).insert([t]).select().single();if(r)throw r;return o})}updateProducto(t,o){return s(this,null,function*(){let{data:r,error:c}=yield this.supabase.client.from(this.TABLE).update(o).eq("id_producto",t).select().single();if(c)throw c;return r})}deleteProducto(t){return s(this,null,function*(){let{error:o}=yield this.supabase.client.from(this.TABLE).delete().eq("id_producto",t);if(o)throw o;return!0})}getProductosStockCritico(t){return s(this,null,function*(){try{let o=this.supabase.client.from(this.TABLE).select("*");try{o=o.or("activo.is.null,activo.eq.true")}catch{console.warn("Campo activo no existe, cargando todos los productos")}t!==void 0?o=o.lte("stock_actual",t):o=o.lte("stock_actual",3);let{data:r,error:c}=yield o.order("stock_actual",{ascending:!0}).limit(20);if(c){console.warn("Error en consulta con filtro activo, intentando sin filtro:",c);let e=this.supabase.client.from(this.TABLE).select("*");t!==void 0?e=e.lte("stock_actual",t):e=e.lte("stock_actual",3);let{data:a,error:i}=yield e.order("stock_actual",{ascending:!0}).limit(20);if(i)throw i;return a.filter(u=>{let _=u.stock_actual||0,p=u.stock_minimo||0,b=t!==void 0?t:p>0?p:3,v=u.activo===null||u.activo===void 0||u.activo===!0;return _<=b&&v})}return r.filter(e=>{let a=e.stock_actual||0,i=e.stock_minimo||0,n=t!==void 0?t:i>0?i:3;return a<=n})}catch(o){return console.error("Error al cargar productos con stock cr\xEDtico:",o),[]}})}registrarMovimientoStock(t){return s(this,null,function*(){let{data:o,error:r}=yield this.supabase.client.from(this.TABLE_MOVIMIENTOS).insert([{id_producto:t.id_producto,tipo:t.tipo,cantidad:t.cantidad,stock_antes:t.stock_antes,stock_despues:t.stock_despues,referencia:t.referencia||null}]).select().single();if(r)throw r;return{data:o,error:r}})}static \u0275fac=function(o){return new(o||l)(m(h))};static \u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})};export{k as a};
